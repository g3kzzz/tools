#!/usr/bin/env bash
# aea.sh - extract ports from nmap -oG output
# Ports -> CLIPBOARD (Ctrl+V)  [SIN ESPACIOS]
# IP    -> PRIMARY   (middle click) [PERSISTENTE / BLOQUEADO]
set -euo pipefail

# --------------------
# Banner / author
# --------------------
AUTHOR="Made by: envertex"
CONTACT="Contact: fabian.huamani@ucsm.edu.pe"
USE_COLOR=true

BANNER_PRINTED=0

_magenta() { printf '\033[95m%s\033[0m' "$1"; }
_print_banner() {
  [[ $BANNER_PRINTED -eq 1 ]] && return
  if $USE_COLOR && [[ -t 1 ]]; then
    _magenta "$AUTHOR"; printf "\n"
    _magenta "$CONTACT"; printf "\n\n"
  else
    printf "%s\n%s\n\n" "$AUTHOR" "$CONTACT"
  fi
  BANNER_PRINTED=1
}

_print_banner

# --------------------
# Arg check
# --------------------
if [[ $# -ne 1 ]]; then
  echo "Usage: $(basename "$0") <nmap_oG_file>"
  exit 1
fi

FILE="$1"
if [[ ! -f "$FILE" ]]; then
  echo "File not found: $FILE"
  exit 1
fi

command -v xclip >/dev/null 2>&1 || {
  echo "xclip is required (sudo pacman -S xclip)"
  exit 1
}

TAB=$'\t'
first_ports_raw=""
first_host=""
found=false

# --------------------
# Parse nmap file
# --------------------
while IFS= read -r line; do
  [[ ! $line =~ ^Host:[[:space:]]+([^[:space:]]+) ]] && continue
  host="${BASH_REMATCH[1]}"

  # Guardar SOLO la primera IP
  [[ -z "$first_host" ]] && first_host="$host"

  ports_field="$(sed -n 's/.*Ports: //p' <<< "$line")"
  [[ -z "$ports_field" ]] && continue

  # PUERTOS LIMPIOS (SIN ESPACIOS) -> CLIPBOARD
  ports_raw="$(tr ',' '\n' <<< "$ports_field" \
    | awk -F'/' '/\/open/ {print $1}' \
    | awk '!seen[$0]++' \
    | paste -sd, -)"

  echo "HOST:"
  echo -e "${TAB}${host}\n"
  echo "PORTS:"

  if [[ -z "$ports_raw" ]]; then
    echo -e "${TAB}(none)\n"
    found=true
    continue
  fi

  # DISPLAY CON ESPACIOS (solo visual)
  IFS=',' read -r -a arr <<< "$ports_raw"
  for ((i=0; i<${#arr[@]}; i+=5)); do
    echo -e "${TAB}$(IFS=', '; echo "${arr[*]:i:5}")"
  done
  echo

  found=true
  [[ -z "$first_ports_raw" ]] && first_ports_raw="$ports_raw"

done < "$FILE"

if ! $found; then
  echo "No hosts or open ports found."
  exit 0
fi

# --------------------
# Clipboard handling
# --------------------

# Ports -> CLIPBOARD (Ctrl+V)
if [[ -n "$first_ports_raw" ]]; then
  printf "%s" "$first_ports_raw" | xclip -selection clipboard
  echo "[+] Ports copied to CLIPBOARD (Ctrl+V): $first_ports_raw"
fi

# IP -> PRIMARY (BLOQUEADO / PERSISTENTE)
if [[ -n "$first_host" ]]; then
  # matar locks previos
  pkill -f "xclip -selection primary" 2>/dev/null || true

  printf "%s" "$first_host" | xclip -selection primary -loops 1 &
  disown
  echo "[+] IP locked in PRIMARY (middle click): $first_host"
fi

exit 0
