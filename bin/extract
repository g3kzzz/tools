#!/usr/bin/env bash
# aea.sh - extract ports from nmap -oG output, print 5 ports per row, copy first host ports to clipboard
set -euo pipefail

if [[ $# -ne 1 ]]; then
  echo "Usage: $0 <nmap_oG_file>"
  exit 1
fi

FILE="$1"
if [[ ! -f "$FILE" ]]; then
  echo "File not found: $FILE"
  exit 1
fi

TAB=$'\t'
first_ports_raw=""
found=false

while IFS= read -r line; do
  # Only process lines starting with "Host:"
  if [[ $line =~ ^Host:[[:space:]]+([^[:space:]]+) ]]; then
    host="${BASH_REMATCH[1]}"

    # Extract "Ports: ..." field if it exists
    ports_field="$(printf '%s' "$line" | sed -n 's/.*Ports: //p' || true)"
    [[ -z "$ports_field" ]] && continue

    # Get only port numbers that are 'open'
    ports_raw="$(printf '%s' "$ports_field" | tr ',' '\n' | awk -F'/' '/\/open/ {gsub(/^[[:space:]]+|[[:space:]]+$/,"",$1); print $1}' | awk '!seen[$0]++' | paste -sd, - || true)"
    ports_raw="${ports_raw:-}"

    # Display (if no open ports found)
    if [[ -z "$ports_raw" ]]; then
      ports_display="(none)"
      echo "HOST:"
      echo -e "${TAB}${host}"
      echo
      echo "PORTS:"
      echo -e "${TAB}${ports_display}"
      echo
      found=true
      continue
    fi

    # Prepare array of ports and print 5 per line
    IFS=',' read -r -a arr <<< "$ports_raw"

    echo "HOST:"
    echo -e "${TAB}${host}"
    echo
    echo "PORTS:"
    idx=0
    total=${#arr[@]}
    while [[ $idx -lt $total ]]; do
      slice=("${arr[@]:idx:5}")
      line=""
      for p in "${slice[@]}"; do
        if [[ -z "$line" ]]; then
          line="$p"
        else
          line="$line, $p"
        fi
      done
      echo -e "${TAB}${line}"
      idx=$((idx + 5))
    done
    echo

    found=true
    # Save first host ports (no spaces) for clipboard
    if [[ -z "$first_ports_raw" ]]; then
      first_ports_raw="$ports_raw"
    fi
  fi
done < "$FILE"

if ! $found; then
  echo "No hosts or open ports found."
  exit 0
fi

# Copy first host ports to clipboard if possible
if [[ -n "$first_ports_raw" ]]; then
  if command -v xclip >/dev/null 2>&1; then
    echo -n "$first_ports_raw" | xclip -selection clipboard
    echo "Copied to clipboard!"
  else
    echo "xclip not installed. Ports not copied."
  fi
fi

exit 0
