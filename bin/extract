#!/usr/bin/env bash
# extractPorts - nmap .gnmap helper
# Ports -> CLIPBOARD (sin espacios)
# IP    -> PRIMARY (REALMENTE BLOQUEADO)

set -uo pipefail

AUTHOR="Made by: envertex"
CONTACT="Contact: fabian.huamani@ucsm.edu.pe"

echo "$AUTHOR"
echo "$CONTACT"
echo

FILE="$1"
[[ -f "$FILE" ]] || { echo "File not found"; exit 1; }
command -v xclip >/dev/null || { echo "xclip required"; exit 1; }

FIFO="/tmp/aea_primary_fifo"

first_host=""
ports_clipboard=""
found=false

# ---------------- Parse nmap ----------------
while IFS= read -r line; do
  [[ ! $line =~ ^Host:[[:space:]]+([^[:space:]]+) ]] && continue
  host="${BASH_REMATCH[1]}"
  [[ -z "$first_host" ]] && first_host="$host"

  ports_field="$(sed -n 's/.*Ports: //p' <<< "$line")"
  [[ -z "$ports_field" ]] && continue

  ports_clipboard="$(tr ',' '\n' <<< "$ports_field" \
    | awk -F'/' '/\/open/ {print $1}' \
    | awk '!seen[$0]++' \
    | paste -sd, - \
    | tr -d ' ')"

  echo "HOST:"
  echo -e "\t$host\n"
  echo "PORTS:"
  IFS=',' read -ra arr <<< "$ports_clipboard"
  for ((i=0;i<${#arr[@]};i+=5)); do
    echo -e "\t$(IFS=', '; echo "${arr[*]:i:5}")"
  done
  echo

  found=true
  break
done < "$FILE"

$found || { echo "No open ports found"; exit 0; }

# ---------------- Clipboard ----------------

# Ports -> CLIPBOARD
printf "%s" "$ports_clipboard" | xclip -selection clipboard
echo "[+] Ports copied to CLIPBOARD: $ports_clipboard"

# ---------------- PRIMARY LOCK (REAL) ----------------

# limpiar locks previos
pkill -f "xclip -selection primary" 2>/dev/null || true
rm -f "$FIFO"
mkfifo "$FIFO"

# mantener FIFO abierto (proceso zombie controlado)
(cat "$FIFO" & ) >/dev/null 2>&1

# escribir IP y fijar PRIMARY
printf "%s" "$first_host" > "$FIFO"
xclip -selection primary < "$FIFO" >/dev/null 2>&1 &

disown
echo "[+] IP REALLY locked in PRIMARY (middle click): $first_host"
