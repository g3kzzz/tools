#!/usr/bin/env bash
# extractPorts - nmap .gnmap helper
# Ports -> CLIPBOARD (Ctrl+V, sin espacios)
# IP    -> PRIMARY (middle click, reinyectado)

set -u

AUTHOR="Made by: envertex_"
CONTACT="Contact: fabian.huamani@ucsm.edu.pe"

echo "$AUTHOR"
echo "$CONTACT"
echo

FILE="${1:-}"
[[ -f "$FILE" ]] || { echo "Usage: extractPorts <nmap.gnmap>"; exit 1; }

command -v xclip >/dev/null || {
  echo "xclip is required (pacman -S xclip)"
  exit 1
}

first_host=""
ports_clipboard=""

# ---------------- Parse gnmap ----------------
while IFS= read -r line; do
  [[ ! $line =~ ^Host:[[:space:]]+([^[:space:]]+) ]] && continue
  first_host="${BASH_REMATCH[1]}"

  ports_field="$(sed -n 's/.*Ports: //p' <<< "$line")"
  [[ -z "$ports_field" ]] && continue

  # Ports LIMPIOS (clipboard)
  ports_clipboard="$(
    tr ',' '\n' <<< "$ports_field" |
    awk -F'/' '/\/open/ {print $1}' |
    awk '!seen[$0]++' |
    paste -sd, - |
    tr -d ' '
  )"

  # Display bonito
  echo "HOST:"
  echo -e "\t$first_host\n"
  echo "PORTS:"
  IFS=',' read -ra arr <<< "$ports_clipboard"
  for ((i=0; i<${#arr[@]}; i+=5)); do
    echo -e "\t$(IFS=', '; echo "${arr[*]:i:5}")"
  done
  echo

  break
done < "$FILE"

[[ -z "$first_host" || -z "$ports_clipboard" ]] && {
  echo "No open ports found"
  exit 0
}

# ---------------- Clipboard ----------------

# Ports -> CLIPBOARD
printf "%s" "$ports_clipboard" | xclip -selection clipboard
echo "[+] Ports in CLIPBOARD (Ctrl+V): $ports_clipboard"

# IP -> PRIMARY (reinjected)
pkill -f "xclip -selection primary" 2>/dev/null || true

(
  while true; do
    printf "%s" "$first_host" | xclip -selection primary
    sleep 0.3
  done
) >/dev/null 2>&1 &

disown
echo "[+] IP pinned to PRIMARY (middle click): $first_host"
