#!/usr/bin/env bash
# extractPorts - nmap .gnmap helper
# Ports -> CLIPBOARD (SIN espacios)
# IP    -> PRIMARY (bloqueado, persistente)

set -uo pipefail   # â— quitamos -e (clave)

AUTHOR="Made by: envertex_"
CONTACT="Contact: fabian.huamani@ucsm.edu.pe"

echo "$AUTHOR"
echo "$CONTACT"
echo

FILE="$1"
[[ -f "$FILE" ]] || { echo "File not found"; exit 1; }

command -v xclip >/dev/null || {
  echo "xclip required"
  exit 1
}

first_host=""
ports_clipboard=""
found=false

while IFS= read -r line; do
  [[ ! $line =~ ^Host:[[:space:]]+([^[:space:]]+) ]] && continue
  host="${BASH_REMATCH[1]}"
  [[ -z "$first_host" ]] && first_host="$host"

  ports_field="$(sed -n 's/.*Ports: //p' <<< "$line")"
  [[ -z "$ports_field" ]] && continue

  # === PUERTOS LIMPIOS (SIN ESPACIOS) ===
  ports_clipboard="$(tr ',' '\n' <<< "$ports_field" \
    | awk -F'/' '/\/open/ {print $1}' \
    | awk '!seen[$0]++' \
    | paste -sd, -)"

  echo "HOST:"
  echo -e "\t$host\n"
  echo "PORTS:"

  # === DISPLAY CON ESPACIOS ===
  IFS=',' read -ra arr <<< "$ports_clipboard"
  for ((i=0; i<${#arr[@]}; i+=5)); do
    echo -e "\t$(IFS=', '; echo "${arr[*]:i:5}")"
  done
  echo

  found=true
  break   # SOLO primer host (intencional)

done < "$FILE"

$found || { echo "No open ports found"; exit 0; }

# --------------------
# CLIPBOARD
# --------------------

# Ports -> CLIPBOARD (SIN espacios)
printf "%s" "$ports_clipboard" | xclip -selection clipboard
echo "[+] Ports copied to CLIPBOARD: $ports_clipboard"

# IP -> PRIMARY (LOCK REAL)
pkill -f "xclip -selection primary" 2>/dev/null || true
printf "%s" "$first_host" | \
  xclip -selection primary -loops 100000 </dev/null >/dev/null 2>&1 &

disown
echo "[+] IP locked in PRIMARY: $first_host"
