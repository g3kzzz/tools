#!/usr/bin/env bash
# aea.sh - extract ports from nmap -oG output
# Ports -> CLIPBOARD (Ctrl+V)
# IP    -> PRIMARY   (middle click)
set -euo pipefail

# --------------------
# Banner / author
# --------------------
AUTHOR="Made by: envertex"
CONTACT="Contact: fabian.huamani@ucsm.edu.pe"
USE_COLOR=true

BANNER_PRINTED=0

_magenta() { printf '\033[95m%s\033[0m' "$1"; }
_print_banner() {
  if [[ $BANNER_PRINTED -eq 1 ]]; then
    return
  fi
  if $USE_COLOR && [[ -t 1 ]]; then
    _magenta "${AUTHOR}"; printf "\n"
    _magenta "${CONTACT}"; printf "\n\n"
  else
    printf "%s\n%s\n\n" "$AUTHOR" "$CONTACT"
  fi
  BANNER_PRINTED=1
}

# Print banner once
_print_banner

# --------------------
# Arg check
# --------------------
if [[ $# -ne 1 ]]; then
  echo "Usage: $(basename "$0") <nmap_oG_file>"
  exit 1
fi

FILE="$1"
if [[ ! -f "$FILE" ]]; then
  echo "File not found: $FILE"
  exit 1
fi

TAB=$'\t'
first_ports_raw=""
first_host=""
found=false

# --------------------
# Parse file
# --------------------
while IFS= read -r line; do
  if [[ $line =~ ^Host:[[:space:]]+([^[:space:]]+) ]]; then
    host="${BASH_REMATCH[1]}"

    # Save first host (IP)
    if [[ -z "$first_host" ]]; then
      first_host="$host"
    fi

    ports_field="$(printf '%s' "$line" | sed -n 's/.*Ports: //p' || true)"
    [[ -z "$ports_field" ]] && continue

    ports_raw="$(printf '%s' "$ports_field" \
      | tr ',' '\n' \
      | awk -F'/' '/\/open/ {print $1}' \
      | awk '!seen[$0]++' \
      | paste -sd, - || true)"

    echo "HOST:"
    echo -e "${TAB}${host}\n"
    echo "PORTS:"

    if [[ -z "$ports_raw" ]]; then
      echo -e "${TAB}(none)\n"
      found=true
      continue
    fi

    IFS=',' read -r -a arr <<< "$ports_raw"
    for ((i=0; i<${#arr[@]}; i+=5)); do
      echo -e "${TAB}$(IFS=', '; echo "${arr[*]:i:5}")"
    done
    echo

    found=true

    # Save first host ports
    if [[ -z "$first_ports_raw" ]]; then
      first_ports_raw="$ports_raw"
    fi
  fi
done < "$FILE"

if ! $found; then
  echo "No hosts or open ports found."
  exit 0
fi

# --------------------
# Clipboard handling
# --------------------
# Ports -> CLIPBOARD
if [[ -n "$first_ports_raw" ]]; then
  if command -v xclip >/dev/null 2>&1; then
    echo -n "$first_ports_raw" | xclip -selection clipboard
    echo "[+] Ports copied to CLIPBOARD (Ctrl+V)"
  elif command -v wl-copy >/dev/null 2>&1; then
    echo -n "$first_ports_raw" | wl-copy
    echo "[+] Ports copied to CLIPBOARD (Ctrl+V)"
  fi
fi

# IP -> PRIMARY
if [[ -n "$first_host" ]]; then
  if command -v xclip >/dev/null 2>&1; then
    echo -n "$first_host" | xclip -selection primary
    echo "[+] IP copied to PRIMARY (middle click)"
  elif command -v wl-copy >/dev/null 2>&1; then
    echo -n "$first_host" | wl-copy --primary
    echo "[+] IP copied to PRIMARY (middle click)"
  fi
fi

exit 0
