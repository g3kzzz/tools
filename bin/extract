#!/usr/bin/env bash
# aea.sh - extract ports from nmap -oG output, print 5 ports per row, copy first host ports to clipboard
set -euo pipefail

# --------------------
# Banner / author
# --------------------
AUTHOR="Made by: envertex"
CONTACT="Contact: fabian.huamani@ucsm.edu.pe"
USE_COLOR=true

BANNER_PRINTED=0

_magenta() { printf '\033[95m%s\033[0m' "$1"; }
_print_banner() {
  if [[ $BANNER_PRINTED -eq 1 ]]; then
    return
  fi
  if $USE_COLOR && [[ -t 1 ]]; then
    _magenta "${AUTHOR}"; printf "\n"
    _magenta "${CONTACT}"; printf "\n\n"
  else
    printf "%s\n%s\n\n" "$AUTHOR" "$CONTACT"
  fi
  BANNER_PRINTED=1
}

# Print banner once at start
_print_banner

# --------------------
# Arg check
# --------------------
if [[ $# -ne 1 ]]; then
  # _print_banner will noop if already printed
  _print_banner
  echo "Usage: $(basename "$0") <nmap_oG_file>"
  exit 1
fi

FILE="$1"
if [[ ! -f "$FILE" ]]; then
  _print_banner
  echo "File not found: $FILE"
  exit 1
fi

TAB=$'\t'
first_ports_raw=""
found=false

while IFS= read -r line; do
  # Only process lines starting with "Host:"
  if [[ $line =~ ^Host:[[:space:]]+([^[:space:]]+) ]]; then
    host="${BASH_REMATCH[1]}"

    # Extract "Ports: ..." field if it exists
    ports_field="$(printf '%s' "$line" | sed -n 's/.*Ports: //p' || true)"
    [[ -z "$ports_field" ]] && continue

    # Get only port numbers that are 'open' (unique, comma-separated)
    ports_raw="$(printf '%s' "$ports_field" \
      | tr ',' '\n' \
      | awk -F'/' '/\/open/ {gsub(/^[[:space:]]+|[[:space:]]+$/,"",$1); print $1}' \
      | awk '!seen[$0]++' \
      | paste -sd, - || true)"
    ports_raw="${ports_raw:-}"

    # Display host and ports
    echo "HOST:"
    echo -e "${TAB}${host}"
    echo
    echo "PORTS:"
    if [[ -z "$ports_raw" ]]; then
      echo -e "${TAB}(none)"
      echo
      found=true
      continue
    fi

    # Print 5 ports per line
    IFS=',' read -r -a arr <<< "$ports_raw"
    idx=0
    total=${#arr[@]}
    while [[ $idx -lt $total ]]; do
      slice=("${arr[@]:idx:5}")
      line=""
      for p in "${slice[@]}"; do
        if [[ -z "$line" ]]; then
          line="$p"
        else
          line="$line, $p"
        fi
      done
      echo -e "${TAB}${line}"
      idx=$((idx + 5))
    done
    echo

    found=true
    # Save first host ports (no spaces) for clipboard
    if [[ -z "$first_ports_raw" ]]; then
      first_ports_raw="$ports_raw"
    fi
  fi
done < "$FILE"

if ! $found; then
  echo "No hosts or open ports found."
  exit 0
fi

# Copy first host ports to clipboard if possible
if [[ -n "$first_ports_raw" ]]; then
  if command -v xclip >/dev/null 2>&1; then
    echo -n "$first_ports_raw" | xclip -selection clipboard
    echo "Copied to clipboard (xclip)!"
  elif command -v wl-copy >/dev/null 2>&1; then
    echo -n "$first_ports_raw" | wl-copy
    echo "Copied to clipboard (wl-copy)!"
  elif command -v pbcopy >/dev/null 2>&1; then
    echo -n "$first_ports_raw" | pbcopy
    echo "Copied to clipboard (pbcopy)!"
  else
    echo "No clipboard utility found (xclip/wl-copy/pbcopy). Ports not copied."
  fi
fi

exit 0

